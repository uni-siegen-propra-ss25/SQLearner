<div class="query-exercise">
  <mat-card-content>
    <h2 class="exercise-title">{{ exercise.title }}</h2>
    <p class="exercise-description">{{ exercise.description }}</p>

    <!-- Database Info -->
    <div class="database-info" *ngIf="exercise.database">
      <mat-chip-listbox>
        <mat-chip color="primary">
          <mat-icon>database</mat-icon>
          {{ exercise.database.name }}
        </mat-chip>
      </mat-chip-listbox>
    </div>

    <!-- SQL Editor -->
    <div class="editor-section">
      <mat-form-field appearance="outline" class="sql-editor">
        <mat-label>Deine SQL Query</mat-label>
        <textarea
          matInput
          [(ngModel)]="sqlQuery"
          rows="6"
          placeholder="SELECT * FROM..."
        ></textarea>
        <mat-hint>Schreibe deine SQL-Abfrage hier</mat-hint>
      </mat-form-field>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button mat-stroked-button (click)="toggleFeedback()">
        <mat-icon>chat</mat-icon>
        {{ showFeedback ? 'Hide Feedback' : 'Show Feedback' }}
      </button>
      <button mat-stroked-button [disabled]="!sqlQuery.trim() || isLoading" (click)="runQuery()">
        <mat-icon>play_arrow</mat-icon>
        Run Query
      </button>
      <button
        mat-flat-button
        color="primary"
        [disabled]="!sqlQuery.trim() || isLoading"
        (click)="submitQuery()"
      >
        <mat-icon>check</mat-icon>
        Submit Answer
      </button>
    </div>

    <!-- Results -->
    <div class="results-section" *ngIf="queryResult || isLoading">
      <h3>Results</h3>
      <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>

      <div class="results-table" *ngIf="!isLoading && queryResult">
        <div class="table-container mat-elevation-z1">
          <table mat-table [dataSource]="queryResult.rows">
            <ng-container
              [matColumnDef]="col"
              *ngFor="let col of queryResult.columns; let i = index"
            >
              <th mat-header-cell *matHeaderCellDef>{{ col }}</th>
              <td mat-cell *matCellDef="let row">{{ row[i] }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="queryResult.columns"></tr>
            <tr mat-row *matRowDef="let row; columns: queryResult.columns"></tr>
          </table>
        </div>
      </div>
    </div>

    <!-- Feedback Section -->
    <mat-expansion-panel *ngIf="showFeedback" class="feedback-section">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>chat</mat-icon>
          AI Feedback
        </mat-panel-title>
      </mat-expansion-panel-header>
      <p>{{ feedback || 'Loading feedback...' }}</p>
    </mat-expansion-panel>
  </mat-card-content>
</div>
